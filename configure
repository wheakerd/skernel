#!/usr/bin/env bash
# configure - detect OS and install required packages

set -e

TOOLS_DIR="tools"
mkdir -p "$TOOLS_DIR"

get_os() {
    case "$(uname)" in
        Darwin)
            echo "macos"
            ;;
        Linux)
            echo "linux"
            ;;
        *)
            echo "Unsupported OS: $(uname). Only Linux and macOS are supported."
            exit 1
            ;;
    esac
}

get_arch() {
    local arch=$(uname -m)

    case "$arch" in
        x86_64)
            echo "x86_64"
            ;;
        aarch64|arm64)
            echo "aarch64"
            ;;
        *)
            echo "Unsupported architecture: $arch. Only x86_64 and aarch64 are supported."
            exit 1
            ;;
    esac
}

get_php_version() {
    local version
    local composer_json="sources/composer.json"

    local version=$(jq -r '.require.php' "$composer_json" | sed -E 's/^[^\d]*([0-9]+\.[0-9]+).*$/\1/')

    if [ -z "$version" ]; then
        echo "PHP version not found or invalid in $composer_json"
        exit 1
    fi

    echo "$version"
}

get_download_link() {
    local json_url="$1"
    local php_type="$2"
    local os_type="$3"
    local arch_type="$4"
    local php_version="$5"

    local JSON=$(curl -fsSL "$json_url")

    local DOWNLOAD_URL=$(echo "$JSON" | jq -r --arg OS "$os_type" --arg ARCH "$arch_type" --arg TYPE "$php_type" --arg VER_PREFIX "$php_version" '
        [ .[]
          | select(.name | test("-" + $TYPE + "-" + $OS + "-" + $ARCH + "\\.tar\\.gz$"))
          | select(.name | test("^php-" + $VER_PREFIX + "\\.[0-9]+"))
        ]
        | reverse
        | .[0]
        | .full_path
    ')

    if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" = "null" ]; then
        echo "No matching PHP build found for OS=$os_type, ARCH=$arch_type, Version=$php_version"
        exit 1
    fi

    local PROTOCOL_DOMAIN=$(echo "$json_url" | grep -oP '^(https?://[^/]+)')

    echo "$PROTOCOL_DOMAIN$DOWNLOAD_URL"
}

# ---------------------------
# Function: download_and_extract
# Arguments:
#   1 - URL
#   2 - Target file name
#   3 - Path inside tar.gz to extract
# ---------------------------
download_and_extract() {
    local url="$1"
    local target="$TOOLS_DIR/$2"
    local set_permissions="${3:-false}"

    local file_name=$(basename "$url")

    if [ -f "$target" ]; then
        echo "‚úÖ $target already exists, skipping download"
        return
    fi

    echo "‚¨áÔ∏è Downloading and extracting $2..."

    local extension="${file_name##*.}"

    if [[ "$file_name" == *.tar.gz ]]; then
        extension="tar.gz"
    elif [[ "$file_name" == *.tar.bz2 ]]; then
        extension="tar.bz2"
    elif [[ "$file_name" == *.tar.xz ]]; then
        extension="tar.xz"
    fi

    echo "üì¶ Extracting file_name file..."

    case "$extension" in
        "tar.gz" | "tgz")
            curl -L "$url" | tar -xz -C "$TOOLS_DIR"
            ;;
        "tar.bz2" | "tbz")
            curl -L "$url" | tar -xj -C "$TOOLS_DIR"
            ;;
        "tar.xz")
            curl -L "$url" | tar -xj -C "$TOOLS_DIR"
            ;;
        "zip")
            curl -L "$url" | funzip | unzip -d "$TOOLS_DIR"
            ;;
        *)
            echo "‚ùå Unsupported file format: $file_name"
            return 1
            ;;
    esac

    if [ "$set_permissions" == "true" ]; then
        chmod +x "$target"
    fi

    echo "‚úÖ $2 download and extraction completed"
}

download_composer() {
    local url="$1"
    local target="$TOOLS_DIR/composer"
    local php_exec="$2"

    if [ -f "$target" ]; then
        echo "‚úÖ $target already exists, skipping download"
        return
    fi

    echo "‚¨áÔ∏è Installing composer using downloaded PHP..."
    curl -fsSL "$url" | "$php_exec" -- --install-dir="$TOOLS_DIR" --filename="composer"
    chmod +x "$target"
    echo "‚úÖ $2 installed"
}

OS=$(get_os)
ARCH=$(get_arch)
PHP_VERSION=$(get_php_version)

# Micro
php_micro_download_link=$(get_download_link "https://dl.static-php.dev/static-php-cli/bulk/?format=json" "micro" "$OS" "$ARCH" "$PHP_VERSION")
download_and_extract "$php_micro_download_link" "micro.sfx"

# PHP-CLI
php_cli_download_link=$(get_download_link "https://dl.static-php.dev/static-php-cli/bulk/?format=json" "cli" "$OS" "$ARCH" "$PHP_VERSION")
download_and_extract "$php_cli_download_link" "php" "true"

#SPC
download_and_extract \
    "https://dl.static-php.dev/static-php-cli/spc-bin/nightly/spc-linux-x86_64.tar.gz" \
    "spc" \
    "true"

# Composer
download_composer \
    "https://getcomposer.org/installer" \
    "$TOOLS_DIR/php"
